<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>arcgis-js-api 4.x 要素服务加载</title>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        .selected-panel {
            position: absolute;
            right: 0px;
            width: 230px;
            height: 65px;
            background: aliceblue;
            z-index: 1;
        }
    </style>

    <link rel="stylesheet" href="https://app.gdeei.cn/arcgis-js-api/library/4.15/esri/themes/light/main.css" />
    <script src="../lib/mapbox/js/mapbox-gl.js"></script>
    <script src="../lib/GeoGlobeSDK/GeoGlobeJS.min.js"></script>
    <script src="../lib/jQuery/jquery-3.4.1.min.js"></script>
    <script src="../lib/jQuery/jquery.xml2json.js"></script>
    <script src="https://app.gdeei.cn/arcgis-js-api/library/4.15/init.js"></script>
    <script src="./layerConfig.js"></script>
	<script src="../js/Tianditu.js"></script>
    <script>
        require(["esri/Map",
            "esri/views/MapView",
            "esri/layers/WebTileLayer",
            "esri/layers/GraphicsLayer",
            "esri/Graphic",
            "esri/geometry/SpatialReference",
            "esri/geometry/Point",
            "esri/layers/support/TileInfo"
        ],
            function (Map, MapView, WebTileLayer, GraphicsLayer, Graphic, SpatialReference, Point, TileInfo) {
                var layerUrl = {
                    gdLayerUrl: "/gmap/gateway/serviceCodeYZT1610609202768", //广东2020年7_17级矢量图
                    gdAnnoLayerUrl: "/gmap/gateway/serviceCodeYZT1610609681389", //广东2020年7_17级矢量注记
                    polygonWfsUrl: "/gmap/gateway/serviceCodeYZT1597746923010",//面要素，广州市县级工作底图界线
                    pointWfsUrl: "/gmap/gateway/serviceCodeYZT1597746931474",//点要素，广东省际检疫站
                    lineWfsUrl: "/gmap/gateway/serviceCodeYZT1597746941420" //线要素，广东2019年末全省高速公路分布
                }

                var spatialReference = new SpatialReference({
                    wkid: 4490
                });
                //底图
                var gdLayer = layerManager(layerUrl.gdLayerUrl);
                //注记
                var gdAnnoLayer = layerManager(layerUrl.gdAnnoLayerUrl);
                var map = new Map({
                    spatialReference: {
                        wkid: 4490
                    },
                    basemap: {
                        baseLayers: [gdLayer, gdAnnoLayer]
                    }
                });
                var pt = new Point({
                    latitude: 23.150817871112068,
                    longitude: 113.28015136716937,
                    spatialReference: { wkid: 4490 }
                });
                var view = new MapView({
                    container: "viewDiv",
                    map: map,
                    spatialReference: {
                        wkid: 4490
                    },
                    zoom: 8,
                    center: pt,
                });

                var graphicsLayer = new GraphicsLayer();

                $(document).on("change", "#typeSelect", function () {
                    graphicsLayer.removeAll();
                    var wfsType = $("#typeSelect").val();
                    if (wfsType == "点要素") {
                        var queryParams = {
                            url: layerUrl.pointWfsUrl,
                            typeName: '广东省际检疫站',
                        }
                        queryWfs(queryParams, function (result) {
                            if (result && result.features.length != 0) {
                                loadPointWfs(result);
                            }
                        })
                    } else if (wfsType == "线要素") {
                        var queryParams = {
                            url: layerUrl.lineWfsUrl,
                            typeName: 'JTYST_GSGL2019',
                            filter: new GeoGlobe.Filter.Comparison({
                                type: GeoGlobe.Filter.Comparison.LIKE,
                                property: "XZQH",
                                value: "4401%"
                            }),
                        }
                        queryWfs(queryParams, function (result) {
                            if (result && result.features.length != 0) {
                                loadPolylineWfs(result);
                            }
                        })
                    } else if (wfsType == "面要素") {
                        var queryParams = {
                            url: layerUrl.polygonWfsUrl,
                            typeName: 'GZSXJXZQHM',
                        }
                        queryWfs(queryParams, function (result) {
                            if (result && result.features.length != 0) {
                                loadPolygonWfs(result);
                            }
                        })
                    }
                })

                $("#typeSelect").change();

                function queryWfs(queryParams, callback) {
                    if (!queryParams || !queryParams.url || !queryParams.typeName) {
                        alert('未获取到查询的配置，无法进行要素查询操作！');
                    } else {
                        var queryObj = new GeoGlobe.Query.WFSQuery(
                        	queryParams.url, //服务地址 
                            queryParams.typeName, //要素分类名 
                            {
                                geometryName: "GEOMETRY",
                                format: new GeoGlobe.Format.GML.v2({ xy: true }),
                                version: "1.0.0",
                                maxFeatures: 999999 //限制查询的结果数 
                            }
                        );
                        queryObj.query(queryParams.filter, callback, getFeatureFailFn);
                    }
                }
                function getFeatureFailFn() {
                    alert("查询失败！");
                }

                function layerManager(serviceUrl) {
                    var xml;
                    $.ajax({
                        type: "get",
                        url: serviceUrl + "?SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetCapabilities",
                        async: false,
                        success: function (result) {
                            xml = result;
                        }
                    });
                    //var xml = this.getCapabilities(serviceUrl);
                    var json = $.xml2json(xml);
                    var data = json.Contents.Layer;
                    var layerName = data.Abstract;
                    var styleName = data.Style.Identifier;
                    var tilematrixset = data.TileMatrixSetLink[0].TileMatrixSet;
                    return new WebTileLayer({
                        urlTemplate: window.location.origin + serviceUrl +
                            "?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=" + layerName + "&STYLE=" + styleName + "&TILEMATRIXSET=" + tilematrixset + "&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}&FORMAT=image/png",
                        spatialReference: spatialReference,
                        tileInfo: new TileInfo(LayerConfig.tileInfo)
                    });
                }
                
                function loadPointWfs(result) {
                    //点样式
                    var markerSymbol = {
                        type: "simple-marker",
                        color: [226, 119, 40],
                        outline: {
                            color: [255, 255, 255],
                            width: 2
                        }
                    };

                    for (var i = 0; i < result.features.length; i++) {
                        var point = { type: "point", longitude: result.features[i].geometry.x, latitude: result.features[i].geometry.y };
                        var pointGraphic = new Graphic({
                            geometry: point,
                            symbol: markerSymbol,
                            attributes: {
                                检疫检查站名称: result.features[i].attributes.检疫检查站名称,
                                具体位置: result.features[i].attributes.具体位置,
                                检查站站长及负责人及联系电话: result.features[i].attributes.检查站站长及负责人及联系电话,
                                地市: result.features[i].attributes.地市
                            },
                            popupTemplate: {
                                title: "属性信息",
                                content: [
                                    {
                                        type: "fields",
                                        fieldInfos: [
                                            {
                                                fieldName: "检疫检查站名称"
                                            },
                                            {
                                                fieldName: "具体位置"
                                            },
                                            {
                                                fieldName: "检查站站长及负责人及联系电话"
                                            },
                                            {
                                                fieldName: "地市"
                                            }
                                        ]
                                    }
                                ]
                            }
                        });
                        graphicsLayer.graphics.push(pointGraphic);
                        // view.graphics.add(pointGraphic)
                    }
                    map.add(graphicsLayer);
                }

                function loadPolylineWfs(result) {
                    //线样式
                    var lineSymbol = {
                        type: "simple-line", // autocasts as SimpleLineSymbol()
                        color: [226, 119, 40],
                        width: 4
                    };
                    var data = result.geojson.features;
                    for (var i = 0; i < data.length; i++) {
                        var polyline = { type: "polyline", paths: data[i].geometry.coordinates };
                        var polylineGraphic = new Graphic({
                            geometry: polyline,
                            symbol: lineSymbol,
                            attributes: {
                                Name: data[i].properties.ROADNAME,
                                Gydw: data[i].properties.GYDW,
                                Gylb: data[i].properties.GYLB
                            },
                            popupTemplate: {
                                title: "属性信息",
                                content: [
                                    {
                                        type: "fields",
                                        fieldInfos: [
                                            {
                                                fieldName: "Name"
                                            },
                                            {
                                                fieldName: "Gydw"
                                            },
                                            {
                                                fieldName: "Gylb"
                                            }
                                        ]
                                    }
                                ]
                            }
                        });
                        graphicsLayer.graphics.push(polylineGraphic);
                        // view.graphics.add(polylineGraphic);
                    }
                    map.add(graphicsLayer);
                }

                function loadPolygonWfs(result) {
                    //面样式
                    var fillSymbol = {
                        type: "simple-fill",
                        color: [227, 139, 79, 0.8],
                        outline: {
                            color: [255, 255, 255],
                            width: 1
                        }
                    };
                    var data = result.geojson.features;
                    for (var i = 0; i < data.length; i++) {
                        var polygon = { type: "polygon", rings: data[i].geometry.coordinates[0] };
                        var polygonGraphic = new Graphic({
                            geometry: polygon,
                            symbol: fillSymbol,
                            attributes: {
                                Name: data[i].properties.XZQMC
                            },
                            popupTemplate: {
                                title: "属性信息",
                                content: [
                                    {
                                        type: "fields",
                                        fieldInfos: [
                                            {
                                                fieldName: "Name"
                                            }
                                        ]
                                    }
                                ]
                            }
                        });
                        graphicsLayer.graphics.push(polygonGraphic);
                        // view.graphics.add(polygonGraphic);
                    }
                    map.add(graphicsLayer);
                }

            });
    </script>
</head>

<body>
    <div class="selected-panel">
        <div style="padding: 20px;">
            <label for="">选择要素类型：</label>
            <select name="" id="typeSelect">
                <option value="点要素">点要素</option>
                <option value="线要素">线要素</option>
                <option value="面要素">面要素</option>
            </select>
        </div>
    </div>
    <div id="viewDiv"></div>
</body>

</html>